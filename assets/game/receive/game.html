<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>í† ëŒì´ í•œê¸€ ë°›ê¸°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

       html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
            /* âœ… ìƒë‹¨ ì—¬ë°± ì™„ì „ ì œê±° */
            margin: 0 !important;
            padding: 0 !important;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: stretch; /* âœ… flex-start â†’ stretch */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .game-container {
            width: 100%;
            max-width: 400px;
            height: 700px; /* âœ… ë¶€ëª¨ ë†’ì´ì— ë§ì¶¤ */
            background: #fff;
            border-radius: 0;
            overflow: hidden;
            box-shadow: none;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .game-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .score {
            font-size: 20px;
            font-weight: bold;
        }

        .hearts {
            display: flex;
            gap: 5px;
            padding-right: 45px;
        }

        .heart {
            font-size: 24px;
        }

        .turn-indicator {
            background: #fff;
            color: #667eea;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            text-align: center;
            margin: 10px 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .boss-alert {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 95;
            animation: fadeIn 0.3s;
        }

        .boss-character {
            width: 120px;
            height: 120px;
            margin-bottom: 20px;
            animation: bossAppear 0.5s;
        }

        @keyframes bossAppear {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .boss-title {
            color: #ffd700;
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .boss-description {
            color: white;
            font-size: 16px;
            text-align: center;
            line-height: 1.6;
            padding: 0 30px;
            margin-bottom: 20px;
        }

        .boss-progress {
            color: #00ff00;
            font-size: 20px;
            font-weight: bold;
            margin-top: 10px;
        }

        .countdown-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 90;
            animation: fadeIn 0.3s;
        }

        .countdown-text {
            color: white;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .countdown-number {
            color: #ffd700;
            font-size: 80px;
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .game-canvas {
            width: 100%;
            flex: 1;
            position: relative;
            background-image: url('./repeat_bg.png');
            background-size: cover;
            background-position: center;
            overflow: hidden;
        }

        .character {
            position: absolute;
            bottom: 20px;
            width: 60px;
            height: 60px;
            transition: left 0.1s linear;
        }

        /* âœ… ë³´í˜¸ë§‰ ì´í™íŠ¸ ì¶”ê°€ */
        .shield-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            border: 4px solid #00ff00;
            border-radius: 50%;
            animation: shieldPulse 1s infinite;
            pointer-events: none;
        }

        @keyframes shieldPulse {
            0%, 100% {
                opacity: 0.6;
                transform: translate(-50%, -50%) scale(1);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
        }

        .falling-item {
            position: absolute;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            background: white;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: top 0.05s linear;
        }

        .consonant {
            color: #667eea;
            border: 3px solid #667eea;
        }

        .vowel {
            color: #f093fb;
            border: 3px solid #f093fb;
        }

        .double-letter {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 100%);
            color: white;
            border: 3px solid #ff6b6b;
        }

        .item-powerup {
            background: linear-gradient(135deg, #00ff00 0%, #00cc00 100%);
            font-size: 24px;
            animation: itemFloat 1s infinite;
        }

        @keyframes itemFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .game-over-screen, .start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
        }

        .game-over-screen h2, .start-screen h2 {
            font-size: 36px;
            margin-bottom: 20px;
            color: #fff;
        }

        .final-score {
            font-size: 24px;
            margin-bottom: 30px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 30px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .instructions {
            color: #ddd;
            text-align: center;
            margin: 20px;
            line-height: 1.6;
        }

        .character-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 15px;
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 101;
        }

        .sound-toggle:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }

        .mobile-controls {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 100px;
            z-index: 105;
        }

        .mobile-controls button {
            font-size: 24px;
            padding: 8px 16px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.5);
            cursor: pointer;
            user-select: none;
            backdrop-filter: blur(5px);
            transition: all 0.2s;
        }

        .mobile-controls button:active {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(0.95);
        }

        /* âœ… ë³´í˜¸ë§‰ íšë“ ì´í™íŠ¸ ê°œì„  */
        .item-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 64px;
            font-weight: bold;
            color: #00ff00;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5),
                         0 0 20px rgba(0,255,0,0.5);
            z-index: 80;
            animation: effectFadeOut 1.5s forwards;
        }

        @keyframes effectFadeOut {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(0.5) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2) rotate(180deg);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -100%) scale(1.5) rotate(360deg);
            }
        }

        /* âœ… ë°ë¯¸ì§€ ì´í™íŠ¸ */
        .damage-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: #ff0000;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: 80;
            animation: damageShake 0.5s forwards;
        }

        @keyframes damageShake {
            0%, 100% { transform: translate(-50%, -50%); opacity: 1; }
            10%, 30%, 50%, 70%, 90% { transform: translate(-45%, -50%); }
            20%, 40%, 60%, 80% { transform: translate(-55%, -50%); }
            100% { opacity: 0; }
        }
    </style>
</head>

<body>
<audio id="bgm" loop>
    <source src="bgm.mp3" type="audio/mpeg">
</audio>

<div class="game-container">
    <button class="sound-toggle" id="soundToggle" onclick="toggleSound()">ğŸ”Š</button>

    <div class="start-screen" id="startScreen">
        <h2>ğŸ® í† ëŒì´ í•œê¸€ ë°›ê¸°</h2>
        <div class="instructions">
            <p>â¬…ï¸ â¡ï¸ ë°©í–¥í‚¤ë¡œ í† ëŒì´ë¥¼ ì›€ì§ì—¬ìš”!</p>
            <p><strong style="color: #667eea;">ììŒ í„´</strong>ì—ëŠ” ììŒë§Œ,</p>
            <p><strong style="color: #f093fb;">ëª¨ìŒ í„´</strong>ì—ëŠ” ëª¨ìŒë§Œ ë°›ì•„ìš”!</p>
            <p>â¤ï¸ í•˜íŠ¸ê°€ 0ì´ ë˜ë©´ ê²Œì„ ì˜¤ë²„!</p>
            <p style="color: #ffd700; margin-top: 10px;">ğŸ¯ ë³´ìŠ¤ ê¸°ë¯¹ì„ í†µê³¼í•˜ë©´ ë³´ë„ˆìŠ¤ ì ìˆ˜!</p>
        </div>
        <button class="btn" onclick="startGame()">ê²Œì„ ì‹œì‘</button>
    </div>

    <div class="boss-alert" id="bossAlert">
        <img class="boss-character" id="bossCharacter" src="" alt="Boss">
        <div class="boss-title" id="bossTitle"></div>
        <div class="boss-description" id="bossDescription"></div>
        <div class="boss-progress" id="bossProgress"></div>
    </div>

    <div class="game-header">
        <div class="score">ì ìˆ˜: <span id="score">0</span></div>
        <div class="hearts" id="hearts">
            <span class="heart">â¤ï¸</span>
            <span class="heart">â¤ï¸</span>
            <span class="heart">â¤ï¸</span>
        </div>
    </div>

    <div class="turn-indicator" id="turnIndicator">ììŒ í„´</div>

    <div class="game-canvas" id="gameCanvas">
        <div class="character" id="character">
            <img id="standingTodoli" class="character-img" src="standing_todoli.png" alt="Standing Todoli" style="display: block;">
            <img id="runLeftTodoli" class="character-img" src="run_todoli_left.png" alt="Running Left Todoli" style="display: none;">
            <img id="runRightTodoli" class="character-img" src="run_todoli_right.png" alt="Running Right Todoli" style="display: none;">
        </div>
    </div>

    <div class="game-over-screen" id="gameOverScreen" style="display: none;">
        <h2>ê²Œì„ ì˜¤ë²„!</h2>
        <div class="final-score">ìµœì¢… ì ìˆ˜: <span id="finalScore">0</span></div>
        <button class="btn" onclick="restartGame()">ë‹¤ì‹œ ì‹œì‘</button>
    </div>

    <div class="mobile-controls">
        <button onmousedown="moveLeft()" onmouseup="stopMove()" ontouchstart="moveLeft()" ontouchend="stopMove()">â—€</button>
        <button onmousedown="moveRight()" onmouseup="stopMove()" ontouchstart="moveRight()" ontouchend="stopMove()">â–¶</button>
    </div>
</div>

<script>
    const bgm = document.getElementById('bgm');
    const soundToggle = document.getElementById('soundToggle');
    let isSoundOn = true;

    function toggleSound() {
        isSoundOn = !isSoundOn;
        if (isSoundOn) {
            bgm.play();
            soundToggle.textContent = 'ğŸ”Š';
        } else {
            bgm.pause();
            soundToggle.textContent = 'ğŸ”‡';
        }
    }

    const bossMechanics = {
        rhythm: {
            name: 'ìš´ìœ¨ìˆ˜í˜¸ì',
            image: 'rhythm.png',
            description: 'ììŒ, ëª¨ìŒ, ììŒ, ëª¨ìŒ, ììŒ ìˆœì„œë¡œ\ní•œê¸€ì„ ë°›ì•„ë‚´ì„¸ìš”!\n5ë²ˆ ì—°ì† ì„±ê³µí•˜ë©´ í†µê³¼!',
            targetCount: 5,
            pattern: ['consonant', 'vowel', 'consonant', 'vowel', 'consonant'],
            bonus: 500
        },
        sculpting: {
            name: 'ë‹¨ì–´ì¡°ê°ê°€',
            image: 'sculpting.png',
            description: 'ììŒê³¼ ëª¨ìŒì„ ì¡°í•©í•´\në‹¨ì–´ê°€ ë˜ë„ë¡ ë°›ìœ¼ì„¸ìš”!\n(ììŒ+ëª¨ìŒ 3ì„¸íŠ¸ ì™„ì„±)',
            targetCount: 3,
            bonus: 300
        },
        outlaw: {
            name: 'í˜¼ì¢…ì¶”ë°©ì',
            image: 'outlaw.png',
            description: '15ì´ˆ ë™ì•ˆ ì´ì¤‘ëª¨ìŒ, ì´ì¤‘ììŒì„\ní”¼í•˜ê³  ë‹¤ë¥¸ ê²ƒë§Œ ë°›ìœ¼ì„¸ìš”!',
            duration: 15,
            bonus: 400
        },
        bottom_love: {
            name: 'ë°›ì¹¨ì‚¬ë‘ê¾¼',
            image: 'bottom_love.png',
            description: 'ë°›ì¹¨ì´ ë  ìˆ˜ ìˆëŠ” ììŒë§Œ\n7ë²ˆ ì—°ì† ë°›ìœ¼ì„¸ìš”!',
            targetCount: 7,
            bonus: 350
        }
    };

    let gameState = {
        score: 0,
        hearts: 3,
        shield: 0,
        isRunning: false,
        currentTurn: 'consonant',
        characterPosition: 160,
        fallingItems: [],
        turnCount: 0,
        itemsCaught: 0,
        isCountingDown: false,
        bossActive: false,
        currentBoss: null,
        bossProgress: 0,
        bossStartTime: 0,
        bossPatternIndex: 0,
        lastWordPart: null
    };

    const consonants = ['ã„±', 'ã„´', 'ã„·', 'ã„¹', 'ã…', 'ã…‚', 'ã……', 'ã…‡', 'ã…ˆ', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];
    const vowels = ['ã…', 'ã…‘', 'ã…“', 'ã…•', 'ã…—', 'ã…›', 'ã…œ', 'ã… ', 'ã…¡', 'ã…£'];
    const doubleConsonants = ['ã„²', 'ã„¸', 'ã…ƒ', 'ã…†', 'ã…‰'];
    const doubleVowels = ['ã…', 'ã…’', 'ã…”', 'ã…–', 'ã…˜', 'ã…™', 'ã…š', 'ã…', 'ã…', 'ã…Ÿ', 'ã…¢'];
    const finalConsonants = ['ã„±', 'ã„´', 'ã„·', 'ã„¹', 'ã…', 'ã…‚', 'ã…‡'];

    const character = document.getElementById('character');
    const gameCanvas = document.getElementById('gameCanvas');
    const scoreElement = document.getElementById('score');
    const heartsElement = document.getElementById('hearts');
    const turnIndicator = document.getElementById('turnIndicator');
    const gameOverScreen = document.getElementById('gameOverScreen');
    const startScreen = document.getElementById('startScreen');
    const standingTodoli = document.getElementById('standingTodoli');
    const runLeftTodoli = document.getElementById('runLeftTodoli');
    const runRightTodoli = document.getElementById('runRightTodoli');
    const bossAlert = document.getElementById('bossAlert');

    let isMoving = false;
    let movingTimeout = null;
    let currentDirection = 'none';
    let keys = {};
    let touchDirection = 'none';
    let touchInterval = null;

    document.addEventListener('keydown', (e) => { keys[e.key] = true; });
    document.addEventListener('keyup', (e) => { keys[e.key] = false; });

    function moveLeft() {
        touchDirection = 'left';
        if (!touchInterval) {
            touchInterval = setInterval(() => {
                if (gameState.characterPosition > 0) {
                    gameState.characterPosition -= 5;
                }
            }, 16);
        }
    }

    function moveRight() {
        touchDirection = 'right';
        if (!touchInterval) {
            touchInterval = setInterval(() => {
                if (gameState.characterPosition < 320) {
                    gameState.characterPosition += 5;
                }
            }, 16);
        }
    }

    function stopMove() {
        touchDirection = 'none';
        clearInterval(touchInterval);
        touchInterval = null;
    }

    function startGame() {
        startScreen.style.display = 'none';
        if (isSoundOn) {
            bgm.play().catch(err => console.log('BGM ìë™ì¬ìƒ ì‹¤íŒ¨:', err));
        }

        gameState = {
            score: 0,
            hearts: 3,
            shield: 0,
            isRunning: true,
            currentTurn: 'consonant',
            characterPosition: 160,
            fallingItems: [],
            turnCount: 0,
            itemsCaught: 0,
            isCountingDown: false,
            bossActive: false,
            currentBoss: null,
            bossProgress: 0,
            bossStartTime: 0,
            bossPatternIndex: 0,
            lastWordPart: null
        };
        updateUI();
        updateHearts();
        gameLoop();
        spawnItems();
    }

    function restartGame() {
        gameOverScreen.style.display = 'none';
        document.querySelectorAll('.falling-item').forEach(item => item.remove());
        document.querySelectorAll('.shield-glow').forEach(shield => shield.remove());
        startGame();
    }

    function startBossMechanic() {
        const bossKeys = Object.keys(bossMechanics);
        const randomBoss = bossKeys[Math.floor(Math.random() * bossKeys.length)];
        const boss = bossMechanics[randomBoss];

        gameState.bossActive = true;
        gameState.currentBoss = randomBoss;
        gameState.bossProgress = 0;
        gameState.bossStartTime = Date.now();
        gameState.bossPatternIndex = 0;
        gameState.lastWordPart = null;

        document.getElementById('bossCharacter').src = boss.image;
        document.getElementById('bossTitle').textContent = `âš¡ ${boss.name} âš¡`;
        document.getElementById('bossDescription').textContent = boss.description;
        document.getElementById('bossProgress').textContent = '';
        bossAlert.style.display = 'flex';

        setTimeout(() => {
            bossAlert.style.display = 'none';
        }, 3000);
    }

    function checkBossMechanic(caughtItem) {
        if (!gameState.bossActive) return true;

        const boss = bossMechanics[gameState.currentBoss];
        let success = false;

        switch (gameState.currentBoss) {
            case 'rhythm':
                const expectedType = boss.pattern[gameState.bossPatternIndex % boss.pattern.length];
                if (caughtItem.type === expectedType) {
                    gameState.bossProgress++;
                    gameState.bossPatternIndex++;
                    success = true;
                    if (gameState.bossProgress >= boss.targetCount) {
                        completeBoss();
                    }
                } else {
                    gameState.bossProgress = 0;
                    gameState.bossPatternIndex = 0;
                }
                break;

            case 'sculpting':
                if (!gameState.lastWordPart) {
                    if (caughtItem.type === 'consonant') {
                        gameState.lastWordPart = 'consonant';
                        success = true;
                    }
                } else if (gameState.lastWordPart === 'consonant' && caughtItem.type === 'vowel') {
                    gameState.bossProgress++;
                    gameState.lastWordPart = null;
                    success = true;
                    if (gameState.bossProgress >= boss.targetCount) {
                        completeBoss();
                    }
                } else {
                    gameState.lastWordPart = null;
                }
                break;

            case 'outlaw':
                const elapsed = (Date.now() - gameState.bossStartTime) / 1000;
                if (caughtItem.isDouble) {
                    gameState.bossActive = false;
                    showItemEffect('âŒ ì‹¤íŒ¨!');
                    return false;
                }
                success = true;
                if (elapsed >= boss.duration) {
                    completeBoss();
                }
                break;

            case 'bottom_love':
                if (caughtItem.type === 'consonant' && finalConsonants.includes(caughtItem.letter)) {
                    gameState.bossProgress++;
                    success = true;
                    if (gameState.bossProgress >= boss.targetCount) {
                        completeBoss();
                    }
                } else {
                    gameState.bossProgress = 0;
                }
                break;
        }

        updateBossProgress();
        return success;
    }

    function updateBossProgress() {
        if (!gameState.bossActive) return;

        const boss = bossMechanics[gameState.currentBoss];
        let progressText = '';

        if (gameState.currentBoss === 'outlaw') {
            const elapsed = Math.floor((Date.now() - gameState.bossStartTime) / 1000);
            const remaining = boss.duration - elapsed;
            progressText = `â±ï¸ ${remaining}ì´ˆ ë‚¨ìŒ`;
        } else {
            progressText = `ì§„í–‰: ${gameState.bossProgress}/${boss.targetCount}`;
        }

        turnIndicator.textContent = `ğŸ¯ ${boss.name} - ${progressText}`;
        turnIndicator.style.color = '#ff6b35';
    }

    function completeBoss() {
        const boss = bossMechanics[gameState.currentBoss];
        gameState.score += boss.bonus;
        gameState.bossActive = false;
        showItemEffect(`âœ¨ +${boss.bonus}ì !`);
        updateUI();
        updateTurnIndicator();
    }

    function spawnItems() {
        if (!gameState.isRunning || gameState.isCountingDown) return;

        const item = document.createElement('div');
        item.className = 'falling-item';

        let itemType, letter, isDouble = false, isItem = false;

        if (Math.random() < 0.1) {
            isItem = true;
            item.textContent = Math.random() < 0.5 ? 'â¤ï¸' : 'ğŸ›¡ï¸';
            item.className = 'falling-item item-powerup';
            item.dataset.itemType = item.textContent === 'â¤ï¸' ? 'heart' : 'shield';
        } else if (gameState.bossActive && gameState.currentBoss === 'outlaw') {
            if (Math.random() < 0.4) {
                isDouble = true;
                const doubles = [...doubleConsonants, ...doubleVowels];
                letter = doubles[Math.floor(Math.random() * doubles.length)];
                itemType = doubleConsonants.includes(letter) ? 'consonant' : 'vowel';
                item.className = 'falling-item double-letter';
            } else {
                itemType = Math.random() < 0.5 ? 'consonant' : 'vowel';
                const letters = itemType === 'consonant' ? consonants : vowels;
                letter = letters[Math.floor(Math.random() * letters.length)];
                item.className = `falling-item ${itemType}`;
            }
            item.textContent = letter;
        } else {
            const isCurrentTurn = Math.random() < 0.7;
            itemType = isCurrentTurn ?
                gameState.currentTurn :
                (gameState.currentTurn === 'consonant' ? 'vowel' : 'consonant');

            const letters = itemType === 'consonant' ? consonants : vowels;
            letter = letters[Math.floor(Math.random() * letters.length)];

            item.textContent = letter;
            item.className = `falling-item ${itemType}`;
        }

        item.dataset.type = itemType;
        item.dataset.letter = letter;
        item.dataset.isDouble = isDouble;
        item.dataset.isItem = isItem;
        item.style.left = Math.random() * 330 + 'px';
        item.style.top = '-50px';

        gameCanvas.appendChild(item);
        gameState.fallingItems.push({
            element: item,
            y: -50,
            x: parseFloat(item.style.left)
        });

        setTimeout(spawnItems, 1500 - Math.min(gameState.score * 10, 800));
    }

    function startTurnCountdown() {
        gameState.isCountingDown = true;
        const nextTurn = gameState.currentTurn === 'consonant' ? 'ëª¨ìŒ' : 'ììŒ';

        const overlay = document.createElement('div');
        overlay.className = 'countdown-overlay';
        overlay.innerHTML = `
            <div class="countdown-text">ë‹¤ìŒ í„´: ${nextTurn} í„´</div>
            <div class="countdown-number" id="countdownNumber">3</div>
        `;
        gameCanvas.appendChild(overlay);

        let count = 3;
        const countdownInterval = setInterval(() => {
            count--;
            const numberElement = document.getElementById('countdownNumber');
            if (numberElement) {
                if (count > 0) {
                    numberElement.textContent = count;
                } else {
                    numberElement.textContent = 'ì‹œì‘!';
                    numberElement.style.color = '#00ff00';
                }
            }

            if (count < 0) {
                clearInterval(countdownInterval);
                overlay.remove();
                gameState.currentTurn = gameState.currentTurn === 'consonant' ? 'vowel' : 'consonant';
                gameState.turnCount++;

                if (gameState.turnCount % 5 === 0 && gameState.turnCount > 0) {
                    startBossMechanic();
                }

                updateTurnIndicator();
                gameState.isCountingDown = false;
                spawnItems();
            }
        }, 1000);
    }

    // âœ… ë³´í˜¸ë§‰ ì‹œê° íš¨ê³¼ í‘œì‹œ
    function showShieldEffect() {
        // ê¸°ì¡´ ë³´í˜¸ë§‰ ì œê±°
        document.querySelectorAll('.shield-glow').forEach(el => el.remove());

        if (gameState.shield > 0) {
            const shieldGlow = document.createElement('div');
            shieldGlow.className = 'shield-glow';
            character.appendChild(shieldGlow);
        }
    }

    function showItemEffect(text) {
        const effect = document.createElement('div');
        effect.className = 'item-effect';
        effect.textContent = text;
        gameCanvas.appendChild(effect);
        setTimeout(() => effect.remove(), 1500);
    }

    // âœ… ë°ë¯¸ì§€ íš¨ê³¼ í‘œì‹œ
    function showDamageEffect() {
        const effect = document.createElement('div');
        effect.className = 'damage-effect';
        effect.textContent = 'ğŸ’” -1';
        gameCanvas.appendChild(effect);
        setTimeout(() => effect.remove(), 500);
    }

    function gameLoop() {
        if (!gameState.isRunning) return;

        let moved = false;
        let direction = 'none';

        if (keys['ArrowLeft'] || touchDirection === 'left') {
            if (gameState.characterPosition > 0) {
                gameState.characterPosition -= 5;
            }
            moved = true;
            direction = 'left';
        }

        if (keys['ArrowRight'] || touchDirection === 'right') {
            if (gameState.characterPosition < 320) {
                gameState.characterPosition += 5;
            }
            moved = true;
            direction = 'right';
        }

        if (moved) {
            if (!isMoving || currentDirection !== direction) {
                isMoving = true;
                currentDirection = direction;
                standingTodoli.style.display = 'none';
                runLeftTodoli.style.display = 'none';
                runRightTodoli.style.display = 'none';

                if (direction === 'left') {
                    runLeftTodoli.style.display = 'block';
                } else if (direction === 'right') {
                    runRightTodoli.style.display = 'block';
                }
            }

            clearTimeout(movingTimeout);
            movingTimeout = setTimeout(() => {
                isMoving = false;
                currentDirection = 'none';
                standingTodoli.style.display = 'block';
                runLeftTodoli.style.display = 'none';
                runRightTodoli.style.display = 'none';
            }, 200);
        }

        character.style.left = gameState.characterPosition + 'px';

        gameState.fallingItems.forEach((item, index) => {
            item.y += 3;
            item.element.style.top = item.y + 'px';

            // âœ… ë” ì •ë°€í•œ ì¶©ëŒ ê°ì§€: ìºë¦­í„°ì™€ ì˜¤ë¸Œì íŠ¸ê°€ ì‹¤ì œë¡œ ê°€ê¹Œìš¸ ë•Œë§Œ
            const charRect = {
                left: gameState.characterPosition + 15,
                right: gameState.characterPosition + 45,
                top: 470,  // ìºë¦­í„° ìƒë‹¨ì„ ë” ì•„ë˜ë¡œ
                bottom: 500
            };

            const itemRect = {
                left: item.x + 15,
                right: item.x + 35,
                top: item.y + 15,
                bottom: item.y + 35
            };

            // ë¨¼ì € Yì¶•(ë†’ì´) ì²´í¬: ì•„ì´í…œì´ ìºë¦­í„°ì™€ ë¹„ìŠ·í•œ ë†’ì´ì— ìˆì„ ë•Œë§Œ
            const verticalOverlap = charRect.top < itemRect.bottom && charRect.bottom > itemRect.top;

            if (!verticalOverlap) return; // Yì¶•ì—ì„œ ê²¹ì¹˜ì§€ ì•Šìœ¼ë©´ íŒ¨ìŠ¤

            // Xì¶•(ì¢Œìš°) ì²´í¬
            const horizontalOverlap = charRect.left < itemRect.right && charRect.right > itemRect.left;

            if (horizontalOverlap && verticalOverlap) {
                // ì¤‘ì‹¬ì  ê±°ë¦¬ë¡œ ìµœì¢… ê²€ì¦ (ë” ì—„ê²©í•˜ê²Œ)
                const charCenterX = (charRect.left + charRect.right) / 2;
                const charCenterY = (charRect.top + charRect.bottom) / 2;
                const itemCenterX = (itemRect.left + itemRect.right) / 2;
                const itemCenterY = (itemRect.top + itemRect.bottom) / 2;

                const distance = Math.sqrt(
                    Math.pow(charCenterX - itemCenterX, 2) +
                    Math.pow(charCenterY - itemCenterY, 2)
                );

                // ê±°ë¦¬ ì œí•œì„ ë” ì—„ê²©í•˜ê²Œ (25 â†’ 30ìœ¼ë¡œ ì•½ê°„ ì™„í™”í•˜ë˜ Yì¶• ì œí•œìœ¼ë¡œ ë³´ì™„)
                if (distance > 30) return;

                const isItem = item.element.dataset.isItem === 'true';

                if (isItem) {
                    const itemType = item.element.dataset.itemType;
                    if (itemType === 'heart') {
                        if (gameState.hearts < 3) {
                            gameState.hearts++;
                            showItemEffect('â¤ï¸ +1');
                            updateHearts();
                        }
                    } else if (itemType === 'shield') {
                        gameState.shield = 1;
                        showItemEffect('ğŸ›¡ï¸ ë³´í˜¸ë§‰ íšë“!');
                        showShieldEffect(); // âœ… ë³´í˜¸ë§‰ ì‹œê° íš¨ê³¼
                    }
                    item.element.style.background = 'rgba(0, 255, 0, 0.5)';
                } else {
                    const itemType = item.element.dataset.type;
                    const letter = item.element.dataset.letter;
                    const isDouble = item.element.dataset.isDouble === 'true';

                    // âœ… ë³´ìŠ¤ ì²´í¬
                    const bossCheck = gameState.bossActive ?
                        checkBossMechanic({ type: itemType, letter: letter, isDouble: isDouble }) :
                        true;

                    // âœ… ì¼ë°˜ í„´ ì²´í¬ (ë³´ìŠ¤ ì•„ë‹ ë•Œë§Œ)
                    const isCorrectTurn = !gameState.bossActive && itemType === gameState.currentTurn;

                    console.log('ğŸ¯ ì¶©ëŒ ì²´í¬:', {
                        itemType,
                        currentTurn: gameState.currentTurn,
                        bossActive: gameState.bossActive,
                        bossCheck,
                        isCorrectTurn,
                        final: (gameState.bossActive && bossCheck) || (!gameState.bossActive && isCorrectTurn)
                    });

                    // âœ… ìµœì¢… íŒì •: (ë³´ìŠ¤ ì¤‘ì´ë©´ ë³´ìŠ¤ ì²´í¬) ë˜ëŠ” (ì¼ë°˜ í„´ì´ë©´ í„´ ì²´í¬)
                    if ((gameState.bossActive && bossCheck) || (!gameState.bossActive && isCorrectTurn)) {
                        gameState.score += 10;
                        if (!gameState.bossActive) {
                            gameState.itemsCaught++;
                        }
                        item.element.style.background = 'rgba(0, 255, 0, 0.5)';

                        if (!gameState.bossActive && gameState.itemsCaught >= 5) {
                            gameState.itemsCaught = 0;
                            startTurnCountdown();
                        }
                    } else {
                        // âœ… ì˜ëª»ëœ ì•„ì´í…œì„ ë¨¹ì—ˆì„ ë•Œ
                        if (gameState.shield > 0) {
                            gameState.shield--;
                            showItemEffect('ğŸ›¡ï¸ ë³´í˜¸ë§‰ -1');
                            if (gameState.shield === 0) {
                                // ë³´í˜¸ë§‰ ì†Œì§„ ì‹œ ì‹œê° íš¨ê³¼ ì œê±°
                                document.querySelectorAll('.shield-glow').forEach(el => el.remove());
                            }
                        } else {
                            gameState.hearts--;
                            showDamageEffect(); // âœ… ë°ë¯¸ì§€ ì´í™íŠ¸
                            updateHearts();
                            if (gameState.hearts <= 0) {
                                gameOver();
                            }
                        }
                        item.element.style.background = 'rgba(255, 0, 0, 0.5)';
                    }
                }

                setTimeout(() => item.element.remove(), 100);
                gameState.fallingItems.splice(index, 1);
                updateUI();
            }

            if (item.y > 460) {
                item.element.remove();
                gameState.fallingItems.splice(index, 1);
            }
        });

        requestAnimationFrame(gameLoop);
    }

    function updateUI() {
        scoreElement.textContent = gameState.score;
    }

    function updateHearts() {
        heartsElement.innerHTML = '';
        for (let i = 0; i < gameState.hearts; i++) {
            heartsElement.innerHTML += '<span class="heart">â¤ï¸</span>';
        }
        for (let i = gameState.hearts; i < 3; i++) {
            heartsElement.innerHTML += '<span class="heart" style="opacity: 0.3;">ğŸ–¤</span>';
        }

        if (gameState.shield > 0) {
            for (let i = 0; i < gameState.shield; i++) {
                heartsElement.innerHTML += '<span class="heart">ğŸ›¡ï¸</span>';
            }
        }
    }

    function updateTurnIndicator() {
        if (gameState.bossActive) {
            updateBossProgress();
        } else {
            turnIndicator.textContent = gameState.currentTurn === 'consonant' ? 'ììŒ í„´' : 'ëª¨ìŒ í„´';
            turnIndicator.style.color = gameState.currentTurn === 'consonant' ? '#667eea' : '#f093fb';
        }
    }

    function gameOver() {
        gameState.isRunning = false;
        document.getElementById('finalScore').textContent = gameState.score;
        gameOverScreen.style.display = 'flex';
        saveGameResult();
    }

    function saveGameResult() {
        let gameResult = 0;
        if (gameState.score >= 500) {
            gameResult = 2;
        } else if (gameState.score >= 300) {
            gameResult = 1;
        }

        const gameData = {
            gameNo: 1,
            gameResult: gameResult,
            gameScore: gameState.score
        };

        console.log('ê²Œì„ ê²°ê³¼ ì „ì†¡:', gameData);

        if (window.FlutterChannel) {
            window.FlutterChannel.postMessage(JSON.stringify(gameData));
        }
    }
</script>
</body>

</html>