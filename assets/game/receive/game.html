<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í† ëŒì´ í•œê¸€ ë°›ê¸°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .game-container {
            width: 380px;
            height: 600px;
            background: #fff;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .game-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .score {
            font-size: 20px;
            font-weight: bold;
        }

        .hearts {
            display: flex;
            gap: 5px;
            padding-right: 45px;
        }

        .heart {
            font-size: 24px;
        }

        .turn-indicator {
            background: #fff;
            color: #667eea;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            text-align: center;
            margin: 10px 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .countdown-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 90;
            animation: fadeIn 0.3s;
        }

        .countdown-text {
            color: white;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .countdown-number {
            color: #ffd700;
            font-size: 80px;
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .game-canvas {
            width: 100%;
            height: 460px;
            position: relative;
            background-image: url('./repeat_bg.png');
            background-size: cover;
            background-position: center;
            overflow: hidden;
        }

        .character {
            position: absolute;
            bottom: 20px;
            width: 60px;
            height: 60px;
            transition: left 0.1s linear;
        }

        .falling-item {
            position: absolute;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            background: white;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: top 0.05s linear;
        }

        .consonant {
            color: #667eea;
            border: 3px solid #667eea;
        }

        .vowel {
            color: #f093fb;
            border: 3px solid #f093fb;
        }

        .game-over-screen,
        .start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
        }

        .game-over-screen h2,
        .start-screen h2 {
            font-size: 36px;
            margin-bottom: 20px;
            color: #fff;
        }

        .final-score {
            font-size: 24px;
            margin-bottom: 30px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 30px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .instructions {
            color: #ddd;
            text-align: center;
            margin: 20px;
            line-height: 1.6;
        }

        .character-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 15px;
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 101;
        }

        .sound-toggle:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }

        .mobile-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 40px;
            z-index: 105;
            /* ê²Œì„ í™”ë©´ ìœ„ */
        }

        .mobile-controls button {
            font-size: 30px;
            padding: 10px 20px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.7);
            border: none;
            cursor: pointer;
            user-select: none;
        }
    </style>
</head>

<body>
    <!-- BGM ì˜¤ë””ì˜¤ (autoplayëŠ” ì‚¬ìš©ì ì¸í„°ë™ì…˜ í›„ ì‹œì‘) -->
    <audio id="bgm" loop>
        <source src="bgm.mp3" type="audio/mpeg">
    </audio>

    <div class="game-container">
        <!-- ì‚¬ìš´ë“œ í† ê¸€ ë²„íŠ¼ -->
        <button class="sound-toggle" id="soundToggle" onclick="toggleSound()">ğŸ”Š</button>

        <!-- ì‹œì‘ í™”ë©´ -->
        <div class="start-screen" id="startScreen">
            <h2>ğŸ® í† ëŒì´ í•œê¸€ ë°›ê¸°</h2>
            <div class="instructions">
                <p>â¬…ï¸ â¡ï¸ ë°©í–¥í‚¤ë¡œ í† ëŒì´ë¥¼ ì›€ì§ì—¬ìš”!</p>
                <p><strong style="color: #667eea;">ììŒ í„´</strong>ì—ëŠ” ììŒë§Œ,</p>
                <p><strong style="color: #f093fb;">ëª¨ìŒ í„´</strong>ì—ëŠ” ëª¨ìŒë§Œ ë°›ì•„ìš”!</p>
                <p>â¤ï¸ í•˜íŠ¸ê°€ 0ì´ ë˜ë©´ ê²Œì„ ì˜¤ë²„!</p>
            </div>
            <button class="btn" onclick="startGame()">ê²Œì„ ì‹œì‘</button>
        </div>

        <!-- ê²Œì„ í—¤ë” -->
        <div class="game-header">
            <div class="score">ì ìˆ˜: <span id="score">0</span></div>
            <div class="hearts" id="hearts">
                <span class="heart">â¤ï¸</span>
                <span class="heart">â¤ï¸</span>
                <span class="heart">â¤ï¸</span>
            </div>
        </div>

        <!-- í„´ í‘œì‹œ -->
        <div class="turn-indicator" id="turnIndicator">
            ììŒ í„´
        </div>

        <!-- ê²Œì„ ìº”ë²„ìŠ¤ -->
        <div class="game-canvas" id="gameCanvas">
            <div class="character" id="character">
                <!-- Standing ì´ë¯¸ì§€ (ê¸°ë³¸) -->
                <img id="standingTodoli" class="character-img" src="standing_todoli.png" alt="Standing Todoli"
                     style="display: block;">

                <!-- Running Left ì´ë¯¸ì§€ (ì™¼ìª½ìœ¼ë¡œ ì›€ì§ì¼ ë•Œ) -->
                <img id="runLeftTodoli" class="character-img" src="run_todoli_left.png" alt="Running Left Todoli"
                     style="display: none;">

                <!-- Running Right ì´ë¯¸ì§€ (ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì›€ì§ì¼ ë•Œ) -->
                <img id="runRightTodoli" class="character-img" src="run_todoli_right.png" alt="Running Right Todoli"
                     style="display: none;">
            </div>
        </div>

        <!-- ê²Œì„ ì˜¤ë²„ í™”ë©´ -->
        <div class="game-over-screen" id="gameOverScreen" style="display: none;">
            <h2>ê²Œì„ ì˜¤ë²„!</h2>
            <div class="final-score">ìµœì¢… ì ìˆ˜: <span id="finalScore">0</span></div>
            <button class="btn" onclick="restartGame()">ë‹¤ì‹œ ì‹œì‘</button>
        </div>

        <!-- ëª¨ë°”ì¼ í„°ì¹˜ ì»¨íŠ¸ë¡¤ -->
        <div class="mobile-controls">
            <button onmousedown="moveLeft()" onmouseup="stopMove()" ontouchstart="moveLeft()"
                ontouchend="stopMove()">â¬…ï¸</button>
            <button onmousedown="moveRight()" onmouseup="stopMove()" ontouchstart="moveRight()"
                ontouchend="stopMove()">â¡ï¸</button>
        </div>

    </div>

    <script>
        // BGM ìš”ì†Œ
        const bgm = document.getElementById('bgm');
        const soundToggle = document.getElementById('soundToggle');
        let isSoundOn = true;

        // ì‚¬ìš´ë“œ í† ê¸€
        function toggleSound() {
            isSoundOn = !isSoundOn;
            if (isSoundOn) {
                bgm.play();
                soundToggle.textContent = 'ğŸ”Š';
            } else {
                bgm.pause();
                soundToggle.textContent = 'ğŸ”‡';
            }
        }

        // ê²Œì„ ìƒíƒœ
        let gameState = {
            score: 0,
            hearts: 3,
            isRunning: false,
            currentTurn: 'consonant', // 'consonant' or 'vowel'
            characterPosition: 160,
            fallingItems: [],
            turnCount: 0,
            itemsCaught: 0,
            isCountingDown: false
        };

        // í•œê¸€ ììŒê³¼ ëª¨ìŒ
        const consonants = ['ã„±', 'ã„´', 'ã„·', 'ã„¹', 'ã…', 'ã…‚', 'ã……', 'ã…‡', 'ã…ˆ', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];
        const vowels = ['ã…', 'ã…‘', 'ã…“', 'ã…•', 'ã…—', 'ã…›', 'ã…œ', 'ã… ', 'ã…¡', 'ã…£'];

        // DOM ìš”ì†Œ
        const character = document.getElementById('character');
        const gameCanvas = document.getElementById('gameCanvas');
        const scoreElement = document.getElementById('score');
        const heartsElement = document.getElementById('hearts');
        const turnIndicator = document.getElementById('turnIndicator');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const startScreen = document.getElementById('startScreen');
        const standingTodoli = document.getElementById('standingTodoli');
        const runLeftTodoli = document.getElementById('runLeftTodoli');
        const runRightTodoli = document.getElementById('runRightTodoli');

        // ìºë¦­í„° ì´ë™ ìƒíƒœ
        let isMoving = false;
        let movingTimeout = null;
        let currentDirection = 'none'; // 'left', 'right', 'none'

        // í‚¤ë³´ë“œ ì…ë ¥
        let keys = {};
        document.addEventListener('keydown', (e) => {
            keys[e.key] = true;
        });
        document.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // í„°ì¹˜ ì´ë™
        let touchDirection = 'none';
        let touchInterval = null;

        function moveLeft() {
            touchDirection = 'left';
            if (!touchInterval) {
                touchInterval = setInterval(() => {
                    if (gameState.characterPosition > 0) {
                        gameState.characterPosition -= 5;
                    }
                }, 16); // ì•½ 60fps
            }
        }

        function moveRight() {
            touchDirection = 'right';
            if (!touchInterval) {
                touchInterval = setInterval(() => {
                    if (gameState.characterPosition < 320) {
                        gameState.characterPosition += 5;
                    }
                }, 16);
            }
        }

        function stopMove() {
            touchDirection = 'none';
            clearInterval(touchInterval);
            touchInterval = null;
        }


        // ê²Œì„ ì‹œì‘
        function startGame() {
            startScreen.style.display = 'none';

            // BGM ì‹œì‘ (ì‚¬ìš©ì ì¸í„°ë™ì…˜ í›„)
            if (isSoundOn) {
                bgm.play().catch(err => console.log('BGM ìë™ì¬ìƒ ì‹¤íŒ¨:', err));
            }

            gameState = {
                score: 0,
                hearts: 3,
                isRunning: true,
                currentTurn: 'consonant',
                characterPosition: 160,
                fallingItems: [],
                turnCount: 0,
                itemsCaught: 0,
                isCountingDown: false
            };
            updateUI();
            gameLoop();
            spawnItems();
        }

        // ê²Œì„ ì¬ì‹œì‘
        function restartGame() {
            gameOverScreen.style.display = 'none';
            // ë–¨ì–´ì§€ëŠ” ì•„ì´í…œ ì œê±°
            document.querySelectorAll('.falling-item').forEach(item => item.remove());
            startGame();
        }

        // ë–¨ì–´ì§€ëŠ” ì•„ì´í…œ ìƒì„±
        function spawnItems() {
            if (!gameState.isRunning || gameState.isCountingDown) return;

            const item = document.createElement('div');
            item.className = 'falling-item';

            // ëœë¤í•˜ê²Œ ììŒ ë˜ëŠ” ëª¨ìŒ ì„ íƒ (70% í˜„ì¬ í„´, 30% ë°˜ëŒ€ í„´)
            const isCurrentTurn = Math.random() < 0.7;
            const isConsonant = isCurrentTurn ?
                (gameState.currentTurn === 'consonant') :
                (gameState.currentTurn === 'vowel');

            const letters = isConsonant ? consonants : vowels;
            const letter = letters[Math.floor(Math.random() * letters.length)];

            item.textContent = letter;
            item.className = `falling-item ${isConsonant ? 'consonant' : 'vowel'}`;
            item.dataset.type = isConsonant ? 'consonant' : 'vowel';
            item.style.left = Math.random() * 330 + 'px';
            item.style.top = '-50px';

            gameCanvas.appendChild(item);
            gameState.fallingItems.push({
                element: item,
                y: -50,
                x: parseFloat(item.style.left)
            });

            // ë‹¤ìŒ ì•„ì´í…œ ìƒì„±
            setTimeout(spawnItems, 1500 - Math.min(gameState.score * 10, 800));
        }

        // í„´ ë³€ê²½ ì¹´ìš´íŠ¸ë‹¤ìš´
        function startTurnCountdown() {
            gameState.isCountingDown = true;

            const nextTurn = gameState.currentTurn === 'consonant' ? 'ëª¨ìŒ' : 'ììŒ';

            // ì¹´ìš´íŠ¸ë‹¤ìš´ ì˜¤ë²„ë ˆì´ ìƒì„±
            const overlay = document.createElement('div');
            overlay.className = 'countdown-overlay';
            overlay.innerHTML = `
                <div class="countdown-text">ë‹¤ìŒ í„´: ${nextTurn} í„´</div>
                <div class="countdown-number" id="countdownNumber">3</div>
            `;
            gameCanvas.appendChild(overlay);

            let count = 3;
            const countdownInterval = setInterval(() => {
                count--;
                const numberElement = document.getElementById('countdownNumber');
                if (numberElement) {
                    if (count > 0) {
                        numberElement.textContent = count;
                    } else {
                        numberElement.textContent = 'ì‹œì‘!';
                        numberElement.style.color = '#00ff00';
                    }
                }

                if (count < 0) {
                    clearInterval(countdownInterval);
                    overlay.remove();

                    // ì‹¤ì œ í„´ ë³€ê²½
                    gameState.currentTurn = gameState.currentTurn === 'consonant' ? 'vowel' : 'consonant';
                    updateTurnIndicator();
                    gameState.isCountingDown = false;

                    // ì•„ì´í…œ ìƒì„± ì¬ê°œ
                    spawnItems();
                }
            }, 1000);
        }

        // ê²Œì„ ë£¨í”„
        function gameLoop() {
            if (!gameState.isRunning) return;

            // í‚¤ë³´ë“œ + í„°ì¹˜ ì´ë™
            let moved = false;
            let direction = 'none';

            if (keys['ArrowLeft'] || touchDirection === 'left') {
                if (gameState.characterPosition > 0) {
                    gameState.characterPosition -= 5;
                }
                moved = true;
                direction = 'left';
            }

            if (keys['ArrowRight'] || touchDirection === 'right') {
                if (gameState.characterPosition < 320) {
                    gameState.characterPosition += 5;
                }
                moved = true;
                direction = 'right';
            }

            // ì´ë¯¸ì§€ ì „í™˜
            if (moved) {
                if (!isMoving || currentDirection !== direction) {
                    isMoving = true;
                    currentDirection = direction;

                    // ëª¨ë“  ì´ë¯¸ì§€ ìˆ¨ê¸°ê¸°
                    standingTodoli.style.display = 'none';
                    runLeftTodoli.style.display = 'none';
                    runRightTodoli.style.display = 'none';

                    // ë°©í–¥ì— ë§ëŠ” ì´ë¯¸ì§€ í‘œì‹œ
                    if (direction === 'left') {
                        runLeftTodoli.style.display = 'block';
                    } else if (direction === 'right') {
                        runRightTodoli.style.display = 'block';
                    }
                }

                // ë©ˆì¶˜ í›„ 0.2ì´ˆ ë’¤ standingìœ¼ë¡œ ì „í™˜
                clearTimeout(movingTimeout);
                movingTimeout = setTimeout(() => {
                    isMoving = false;
                    currentDirection = 'none';
                    standingTodoli.style.display = 'block';
                    runLeftTodoli.style.display = 'none';
                    runRightTodoli.style.display = 'none';
                }, 200);
            }

            character.style.left = gameState.characterPosition + 'px';

            // ì•„ì´í…œ ë–¨ì–´ëœ¨ë¦¬ê¸°
            gameState.fallingItems.forEach((item, index) => {
                item.y += 3;
                item.element.style.top = item.y + 'px';

                // ì¶©ëŒ ì²´í¬
                const charRect = {
                    left: gameState.characterPosition,
                    right: gameState.characterPosition + 60,
                    top: 400,
                    bottom: 460
                };

                const itemRect = {
                    left: item.x,
                    right: item.x + 50,
                    top: item.y,
                    bottom: item.y + 50
                };

                if (charRect.left < itemRect.right &&
                    charRect.right > itemRect.left &&
                    charRect.top < itemRect.bottom &&
                    charRect.bottom > itemRect.top) {

                    // ì¶©ëŒ ë°œìƒ
                    const itemType = item.element.dataset.type;
                    if (itemType === gameState.currentTurn) {
                        // ì˜¬ë°”ë¥¸ ì•„ì´í…œ
                        gameState.score += 10;
                        gameState.itemsCaught++;
                        item.element.style.background = 'rgba(0, 255, 0, 0.5)';

                        // í„´ ë³€ê²½ (5ê°œë§ˆë‹¤, ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹¤í–‰)
                        if (gameState.itemsCaught >= 5) {
                            gameState.itemsCaught = 0;
                            startTurnCountdown();
                        }
                    } else {
                        // ì˜ëª»ëœ ì•„ì´í…œ
                        gameState.hearts--;
                        item.element.style.background = 'rgba(255, 0, 0, 0.5)';
                        updateHearts();

                        if (gameState.hearts <= 0) {
                            gameOver();
                        }
                    }

                    setTimeout(() => {
                        item.element.remove();
                    }, 100);
                    gameState.fallingItems.splice(index, 1);
                    updateUI();
                }

                // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°„ ì•„ì´í…œ ì œê±°
                if (item.y > 460) {
                    item.element.remove();
                    gameState.fallingItems.splice(index, 1);
                }
            });

            requestAnimationFrame(gameLoop);
        }

        // í‚¤ë³´ë“œ ì´ë™
        let moved = false;
        let direction = 'none';

        if (keys['ArrowLeft'] || touchDirection === 'left') {
            if (gameState.characterPosition > 0) {
                gameState.characterPosition -= 5;
            }
            moved = true;
            direction = 'left';
        }

        if (keys['ArrowRight'] || touchDirection === 'right') {
            if (gameState.characterPosition < 320) {
                gameState.characterPosition += 5;
            }
            moved = true;
            direction = 'right';
        }

        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            scoreElement.textContent = gameState.score;
        }

        function updateHearts() {
            heartsElement.innerHTML = '';
            for (let i = 0; i < gameState.hearts; i++) {
                heartsElement.innerHTML += '<span class="heart">â¤ï¸</span>';
            }
            for (let i = gameState.hearts; i < 3; i++) {
                heartsElement.innerHTML += '<span class="heart" style="opacity: 0.3;">ğŸ–¤</span>';
            }
        }

        function updateTurnIndicator() {
            turnIndicator.textContent = gameState.currentTurn === 'consonant' ? 'ììŒ í„´' : 'ëª¨ìŒ í„´';
            turnIndicator.style.color = gameState.currentTurn === 'consonant' ? '#667eea' : '#f093fb';
        }

        // ê²Œì„ ì˜¤ë²„
        function gameOver() {
            gameState.isRunning = false;
            document.getElementById('finalScore').textContent = gameState.score;
            gameOverScreen.style.display = 'flex';

            // ê²Œì„ ê²°ê³¼ ì €ì¥ (Spring API í˜¸ì¶œ)
            saveGameResult();
        }

        // ê²Œì„ ê²°ê³¼ ì„œë²„ì— ì €ì¥
        async function saveGameResult() {
            const gameResult = {
                gameResult: gameState.score >= 100 ? 1 : 0, // 100ì  ì´ìƒì´ë©´ ì„±ê³µ
                gameScore: gameState.score,
                gameNo: 1, // í•œê¸€ë°›ê¸° ê²Œì„ ë²ˆí˜¸
                userNo: 1  // ì‹¤ì œë¡œëŠ” ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ë²ˆí˜¸ë¥¼ ì‚¬ìš©
            };

            try {
                // Spring Boot API ì—”ë“œí¬ì¸íŠ¸ë¡œ ì „ì†¡
                // const response = await fetch('/api/game/save', {
                //     method: 'POST',
                //     headers: {
                //         'Content-Type': 'application/json',
                //     },
                //     body: JSON.stringify(gameResult)
                // });

                console.log('ê²Œì„ ê²°ê³¼ ì €ì¥:', gameResult);
                // alert('ê²Œì„ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('ê²Œì„ ê²°ê³¼ ì €ì¥ ì‹¤íŒ¨:', error);
            }
        }
    </script>
</body>

</html>