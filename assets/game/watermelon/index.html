
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œê¸€ ìˆ˜ë°•ê²Œì„</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #gameContainer {
            width: 100%;
            max-width: 400px;
            height: 600px;
            max-height: 100vh;
            background: #FFF9E6;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #topUI {
            position: relative;
            width: 100%;
            background: linear-gradient(to bottom, #FFE5B4 0%, #FFF9E6 100%);
            padding: 8px 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            flex-shrink: 0;
        }

        #scoreBoard {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        #score {
            background: white;
            border: 2px solid #FFB84D;
            border-radius: 15px;
            padding: 6px 15px;
            font-size: 16px;
            font-weight: bold;
            color: #FF6B35;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        #nextFruitBox {
            background: white;
            border: 2px solid #FFB84D;
            border-radius: 15px;
            padding: 6px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        #nextFruitBox .label {
            font-size: 10px;
            font-weight: bold;
            color: #666;
            margin-bottom: 3px;
        }

        #nextFruitPreview {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #skinSelector {
            background: white;
            border: 2px solid #FFB84D;
            border-radius: 15px;
            padding: 6px 15px;
            font-size: 14px;
            font-weight: bold;
            color: #FF6B35;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        #skinSelector:active {
            transform: scale(0.95);
        }

        #gameArea {
            position: relative;
            flex: 1;
            min-height: 0;
            background: linear-gradient(to bottom, #E8F4F8 0%, #FFF9E6 50%, #F5DEB3 100%);
            overflow: hidden;
        }

        #dropZone {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background: rgba(255, 184, 77, 0.15);
            border-bottom: 2px dashed #FFB84D;
            z-index: 50;
        }

        #nextFruit {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 600;
            pointer-events: none;
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            background: transparent;
            display: block;
        }

        #skinModal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        #skinModalContent {
            background: linear-gradient(to bottom, #FFF9E6, #FFE5B4);
            border: 4px solid #FFB84D;
            border-radius: 25px;
            padding: 25px 15px;
            max-width: 300px;
            width: 85%;
            max-height: 75%;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        #closeModalX {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #FF6B35;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        #closeModalX:active {
            transform: scale(0.9);
        }

        #skinModalContent h2 {
            text-align: center;
            color: #FF6B35;
            font-size: 24px;
            margin-bottom: 15px;
            text-shadow: 2px 2px 0px #FFB84D;
        }

        .skinOption {
            background: white;
            border: 2px solid #FFB84D;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
        }

        .skinOption:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .skinOption.selected {
            background: #FFF4E0;
            border-color: #FF6B35;
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.3);
        }

        .skinOption .icon {
            font-size: 28px;
            min-width: 35px;
            text-align: center;
        }

        .skinOption .name {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        #closeModal {
            background: #FF6B35;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 10px;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            margin-top: 12px;
            cursor: pointer;
            box-shadow: 0 3px 12px rgba(255, 107, 53, 0.3);
        }

        #closeModal:active {
            transform: scale(0.95);
        }

        #gameOver {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        #gameOverContent {
            background: white;
            padding: 35px 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 300px;
        }

        #gameOverContent h2 {
            font-size: 32px;
            color: #FF6B35;
            margin-bottom: 15px;
        }

        #gameOverContent p {
            font-size: 20px;
            color: #333;
            margin-bottom: 25px;
        }

        #restartBtn {
            background: #FF6B35;
            color: white;
            border: none;
            border-radius: 15px;
            padding: 12px 35px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
        }

        #restartBtn:active {
            transform: scale(0.95);
        }

        #characters {
            position: absolute;
            top: 15px;
            width: 100%;
            display: flex;
            padding-left: 170px;
            pointer-events: none;
            z-index: 100;
        }

        .character {
            padding: 5px;
        }

        .character>img {
            height: 50px;
            display: block;
        }

    </style>
</head>

<body>
<!-- âŒ ì˜¤ë””ì˜¤ íƒœê·¸ ì£¼ì„ ì²˜ë¦¬ ë˜ëŠ” ì‚­ì œ -->
<!--
<audio id="bgm" loop volume="0.3">
    <source src="bgm.mp3" type="audio/mpeg">
</audio>
<audio id="dropSound">
    <source src="drop.mp3" type="audio/mpeg">
</audio>
-->

<div id="gameContainer">
    <div id="topUI">
        <div id="scoreBoard">
            <div id="score">ì ìˆ˜: 0</div>
            <div id="nextFruitBox">
                <div class="label">NEXT</div>
                <div id="nextFruitPreview"></div>
            </div>
        </div>
        <div id="skinSelector">
            <span>ğŸ¨</span>
            <span id="currentSkinName">ê³¼ì¼</span>
        </div>
        <div id="characters">
            <div class="character">
                <img src="./water_melon_cut.png" alt="ìˆ˜ë°•ë¨¹ëŠ”í† ëŒì´ì™€í˜¸ìˆœì´" />
            </div>
        </div>
    </div>

    <div id="gameArea">
        <div id="dropZone"></div>
        <div id="nextFruit"></div>
        <canvas id="gameCanvas"></canvas>
    </div>

    <div id="skinModal">
        <div id="skinModalContent">
            <button id="closeModalX">Ã—</button>
            <h2>ì¹´í…Œê³ ë¦¬ ì„ íƒ</h2>
            <div class="skinOption selected" data-category="fruit">
                <div class="icon">ğŸ</div>
                <div class="name">ê³¼ì¼</div>
            </div>
            <div class="skinOption" data-category="vehicle">
                <div class="icon">ğŸš—</div>
                <div class="name">íƒˆê²ƒ</div>
            </div>
            <div class="skinOption" data-category="animal">
                <div class="icon">ğŸ¾</div>
                <div class="name">ë™ë¬¼</div>
            </div>
            <div class="skinOption" data-category="nature">
                <div class="icon">ğŸŒ±</div>
                <div class="name">ì‹ë¬¼/ìì—°</div>
            </div>
            <div class="skinOption" data-category="tool">
                <div class="icon">âš™ï¸</div>
                <div class="name">ë„êµ¬/ë¬¸ëª…</div>
            </div>
            <div class="skinOption" data-category="building">
                <div class="icon">ğŸ </div>
                <div class="name">ê±´ì¶•ë¬¼</div>
            </div>
            <button id="closeModal">ì ìš©í•˜ê¸°</button>
        </div>
    </div>

    <div id="gameOver">
        <div id="gameOverContent">
            <h2>ê²Œì„ ì˜¤ë²„!</h2>
            <p id="finalScore">ìµœì¢… ì ìˆ˜: 0</p>
            <button id="restartBtn">ë‹¤ì‹œ í•˜ê¸°</button>
        </div>
    </div>
</div>

<script>
    const categories = {
        fruit: [
            { name: 'ì²´ë¦¬', color: '#ff6b6b', size: 25, shape: 'circle' },
            { name: 'ê·¤', color: '#ffa500', size: 35, shape: 'circle' },
            { name: 'ì‚¬ê³¼', color: '#ff4757', size: 45, shape: 'circle' },
            { name: 'ë°°', color: '#ffd93d', size: 55, shape: 'circle' },
            { name: 'ìëª½', color: '#ffb8b8', size: 65, shape: 'circle' },
            { name: 'íŒŒì¸ì• í”Œ', color: '#f9ca24', size: 70, shape: 'pineapple' },
            { name: 'ë©œë¡ ', color: '#95e1d3', size: 75, shape: 'oval' },
            { name: 'ë§ê³ ', color: '#feca57', size: 100, shape: 'mango' },
            { name: 'ìš©ê³¼', color: '#ff6348', size: 115, shape: 'oval' },
            { name: 'ìˆ˜ë°•', color: '#38ada9', size: 150, shape: 'circle' },
            { name: 'ê³¼ì¼ë°”êµ¬ë‹ˆ', color: '#cd84f1', size: 200, shape: 'basket' }
        ],
        vehicle: [
            { name: 'í‚¥ë³´ë“œ', color: '#74b9ff', size: 30, shape: 'kickboard' },
            { name: 'ìì „ê±°', color: '#0984e3', size: 40, shape: 'bicycle' },
            { name: 'ì˜¤í† ë°”ì´', color: '#6c5ce7', size: 50, shape: 'motorcycle' },
            { name: 'ìë™ì°¨', color: '#fd79a8', size: 60, shape: 'car' },
            { name: 'íŠ¸ëŸ­', color: '#fdcb6e', size: 70, shape: 'truck' },
            { name: 'ë²„ìŠ¤', color: '#f39c12', size: 80, shape: 'bus' },
            { name: 'ê¸°ì°¨', color: '#e17055', size: 90, shape: 'train' },
            { name: 'ë¹„í–‰ê¸°', color: '#00b894', size: 95, shape: 'airplane' },
            { name: 'ìš°ì£¼ì„ ', color: '#a29bfe', size: 105, shape: 'spaceship' },
            { name: 'ë¡œì¼“', color: '#e84393', size: 150, shape: 'rocket' },
            { name: 'UFO', color: '#00cec9', size: 200, shape: 'ufo' }
        ],
        animal: [
            { name: 'ê°œë¯¸', color: '#2d3436', size: 20, shape: 'circle' },
            { name: 'ë²Œ', color: '#feca57', size: 28, shape: 'circle' },
            { name: 'ì¥', color: '#95afc0', size: 35, shape: 'circle' },
            { name: 'í† ë¼', color: '#ffcccc', size: 45, shape: 'circle' },
            { name: 'ì—¬ìš°', color: '#ff7675', size: 55, shape: 'circle' },
            { name: 'ëŠ‘ëŒ€', color: '#636e72', size: 65, shape: 'circle' },
            { name: 'ê³°', color: '#8b4513', size: 75, shape: 'circle' },
            { name: 'ì‚¬ì', color: '#f39c12', size: 85, shape: 'circle' },
            { name: 'ì½”ë¼ë¦¬', color: '#95a5a6', size: 95, shape: 'circle' },
            { name: 'ê³ ë˜', color: '#3498db', size: 150, shape: 'whale' },
            { name: 'ìš©', color: '#9b59b6', size: 200, shape: 'dragon' }
        ],
        nature: [
            { name: 'ìƒˆì‹¹', color: '#b8e994', size: 25, shape: 'sprout' },
            { name: 'í’€', color: '#78e08f', size: 30, shape: 'grass' },
            { name: 'ê½ƒ', color: '#ffb8b8', size: 40, shape: 'flower' },
            { name: 'ê´€ëª©', color: '#6ab04c', size: 50, shape: 'bush' },
            { name: 'ë‚˜ë¬´', color: '#4a7c59', size: 60, shape: 'tree' },
            { name: 'ìˆ²', color: '#218c74', size: 75, shape: 'circle' },
            { name: 'ì •ì›', color: '#38ada9', size: 85, shape: 'circle' },
            { name: 'ì‚°', color: '#8395a7', size: 90, shape: 'mountain' },
            { name: 'ë°€ë¦¼', color: '#05c46b', size: 95, shape: 'circle' },
            { name: 'ëŒ€ì§€', color: '#8b7355', size: 150, shape: 'circle' },
            { name: 'í–‰ì„±', color: '#4834df', size: 200, shape: 'circle' }
        ],
        tool: [
            { name: 'ëŒ', color: '#95a5a6', size: 30, shape: 'stone' },
            { name: 'ì¹¼', color: '#bdc3c7', size: 35, shape: 'knife' },
            { name: 'ë§ì¹˜', color: '#7f8c8d', size: 45, shape: 'hammer' },
            { name: 'í™œ', color: '#d35400', size: 55, shape: 'bow' },
            { name: 'ì¢…ì´', color: '#ecf0f1', size: 50, shape: 'paper' },
            { name: 'ëŒ€í¬', color: '#34495e', size: 65, shape: 'cannon' },
            { name: 'ì‹œê³„', color: '#f39c12', size: 70, shape: 'circle' },
            { name: 'ì „êµ¬', color: '#f1c40f', size: 80, shape: 'bulb' },
            { name: 'ì»´í“¨í„°', color: '#3498db', size: 100, shape: 'computer' },
            { name: 'ë¡œë´‡', color: '#9b59b6', size: 150, shape: 'robot' },
            { name: 'AI', color: '#e74c3c', size: 200, shape: 'circle' }
        ],
        building: [
            { name: 'í…íŠ¸', color: '#f39c12', size: 35, shape: 'tent' },
            { name: 'ì˜¤ë‘ë§‰', color: '#d35400', size: 45, shape: 'hut' },
            { name: 'ì§‘', color: '#e74c3c', size: 55, shape: 'house' },
            { name: 'ì•„íŒŒíŠ¸', color: '#95a5a6', size: 70, shape: 'apartment' },
            { name: 'ë§ˆì„', color: '#3498db', size: 80, shape: 'circle' },
            { name: 'ë„ì‹œ', color: '#2c3e50', size: 90, shape: 'circle' },
            { name: 'ìˆ˜ë„', color: '#34495e', size: 95, shape: 'circle' },
            { name: 'êµ­ê°€', color: '#16a085', size: 100, shape: 'circle' },
            { name: 'ëŒ€ë¥™', color: '#27ae60', size: 115, shape: 'circle' },
            { name: 'ì§€êµ¬', color: '#2980b9', size: 150, shape: 'circle' },
            { name: 'ìš°ì£¼ì •ê±°ì¥', color: '#8e44ad', size: 200, shape: 'station' }
        ]
    };

    const { Engine, Render, Runner, Bodies, World, Events, Body } = Matter;

    const canvas = document.getElementById('gameCanvas');
    const gameArea = document.getElementById('gameArea');

    // ì‹¤ì œ ë Œë”ë§ë˜ëŠ” í¬ê¸° ê³„ì‚°
    function initGame() {
        const rect = gameArea.getBoundingClientRect();
        const width = rect.width;
        const height = rect.height;

        const engine = Engine.create();
        const world = engine.world;
        world.gravity.y = 1;

        const render = Render.create({
            canvas: canvas,
            engine: engine,
            options: {
                width: width,
                height: height,
                wireframes: false,
                background: 'transparent'
            }
        });

        Render.run(render);
        const runner = Runner.create();
        Runner.run(runner, engine);

        const wallOptions = { isStatic: true, render: { fillStyle: '#dfe6e9' } };
        const ground = Bodies.rectangle(width / 2, height - 10, width, 20, wallOptions);
        const leftWall = Bodies.rectangle(10, height / 2, 20, height, wallOptions);
        const rightWall = Bodies.rectangle(width - 10, height / 2, 20, height, wallOptions);

        World.add(world, [ground, leftWall, rightWall]);

        return { engine, world, render, width, height };
    }

    const game = initGame();
    const { engine, world, render, width, height } = game;

    // âŒ ì˜¤ë””ì˜¤ ê´€ë ¨ ë³€ìˆ˜ ì£¼ì„ ì²˜ë¦¬
    // const bgm = document.getElementById('bgm');
    // const dropSound = document.getElementById('dropSound');

    let score = 0;
    let currentCategory = 'fruit';
    let currentFruitLevel = Math.floor(Math.random() * 5);
    let nextFruitLevel = Math.floor(Math.random() * 5);
    let canDrop = true;
    let gameOverFlag = false;
    let dropX = width / 2;
    let isDragging = false;

    // âŒ ì˜¤ë””ì˜¤ ì¬ìƒ ì½”ë“œ ì£¼ì„ ì²˜ë¦¬
    document.addEventListener('click', () => {
        // if (bgm.paused) {
        //     bgm.play().catch(e => console.log('BGM ì¬ìƒ ì‹¤íŒ¨:', e));
        // }
    }, { once: true });

    function createBody(level, x, y) {
        const fruit = categories[currentCategory][level];
        let body;

        switch (fruit.shape) {
            case 'circle':
                body = Bodies.circle(x, y, fruit.size / 2, {
                    restitution: 0.3,
                    friction: 0.5,
                    density: 0.001
                });
                break;
            case 'oval':
                body = Bodies.circle(x, y, fruit.size / 2, {
                    restitution: 0.3,
                    friction: 0.5,
                    density: 0.001
                });
                Body.scale(body, 1, 1.2);
                break;
            default:
                body = Bodies.circle(x, y, fruit.size / 2, {
                    restitution: 0.3,
                    friction: 0.5,
                    density: 0.001
                });
        }

        body.render.fillStyle = fruit.color;
        body.fruitLevel = level;
        body.label = 'fruit';

        return body;
    }

    function updateNextFruit() {
        const nextFruitDiv = document.getElementById('nextFruit');
        const nextFruitPreview = document.getElementById('nextFruitPreview');

        const currentFruit = categories[currentCategory][currentFruitLevel];
        const nextFruit = categories[currentCategory][nextFruitLevel];

        nextFruitDiv.innerHTML = `
            <div style="
                background: ${currentFruit.color};
                border-radius: ${currentFruit.shape === 'circle' ? '50%' : '15px'};
                width: ${currentFruit.size}px;
                height: ${currentFruit.size}px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                color: white;
                font-size: ${currentFruit.size * 0.3}px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            ">${currentFruit.name}</div>
        `;

        nextFruitPreview.innerHTML = `
            <div style="
                background: ${nextFruit.color};
                border-radius: 50%;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                color: white;
                font-size: 10px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            ">${nextFruit.name}</div>
        `;
    }

    function dropFruit(x) {
        if (!canDrop || gameOverFlag) return;

        const fruit = categories[currentCategory][currentFruitLevel];
        const minX = 30 + fruit.size / 2;
        const maxX = width - 30 - fruit.size / 2;
        x = Math.max(minX, Math.min(maxX, x));

        canDrop = false;
        const body = createBody(currentFruitLevel, x, 70);
        World.add(world, body);

        // âŒ íš¨ê³¼ìŒ ì¬ìƒ ì£¼ì„ ì²˜ë¦¬
        // dropSound.currentTime = 0;
        // dropSound.play().catch(e => console.log('íš¨ê³¼ìŒ ì¬ìƒ ì‹¤íŒ¨:', e));

        currentFruitLevel = nextFruitLevel;
        nextFruitLevel = Math.floor(Math.random() * 5);
        updateNextFruit();

        setTimeout(() => {
            canDrop = true;
        }, 500);
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown' || e.key === 'Down') {
            e.preventDefault();
            dropFruit(dropX);
        }
    });

    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        isDragging = true;
    });

    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (isDragging) {
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            dropX = touch.clientX - rect.left;

            const nextFruitDiv = document.getElementById('nextFruit');
            nextFruitDiv.style.left = dropX + 'px';
            nextFruitDiv.style.transform = 'translateX(-50%)';
        }
    });

    canvas.addEventListener('touchend', (e) => {
        e.preventDefault();
        if (isDragging) {
            dropFruit(dropX);
            isDragging = false;
        }
    });

    canvas.addEventListener('mousedown', (e) => {
        isDragging = true;
    });

    canvas.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect();
        dropX = e.clientX - rect.left;

        const nextFruitDiv = document.getElementById('nextFruit');
        nextFruitDiv.style.left = dropX + 'px';
        nextFruitDiv.style.transform = 'translateX(-50%)';
    });

    canvas.addEventListener('mouseup', (e) => {
        if (isDragging) {
            const rect = canvas.getBoundingClientRect();
            dropX = e.clientX - rect.left;
            dropFruit(dropX);
            isDragging = false;
        }
    });

    Events.on(engine, 'collisionStart', (event) => {
        event.pairs.forEach((pair) => {
            const { bodyA, bodyB } = pair;

            if (bodyA.label === 'fruit' && bodyB.label === 'fruit' &&
                bodyA.fruitLevel === bodyB.fruitLevel &&
                bodyA.fruitLevel < categories[currentCategory].length - 1) {

                const level = bodyA.fruitLevel;
                const x = (bodyA.position.x + bodyB.position.x) / 2;
                const y = (bodyA.position.y + bodyB.position.y) / 2;

                World.remove(world, [bodyA, bodyB]);

                const newBody = createBody(level + 1, x, y);
                World.add(world, newBody);

                score += (level + 1) * 10;
                document.getElementById('score').textContent = `ì ìˆ˜: ${score}`;
            } else if (bodyA.label === 'fruit' && bodyB.label === 'fruit' &&
                       bodyA.fruitLevel === bodyB.fruitLevel &&
                       bodyA.fruitLevel === categories[currentCategory].length - 1) {
                World.remove(world, [bodyA, bodyB]);
                score += 1000;
                document.getElementById('score').textContent = `ì ìˆ˜: ${score}`;
            }
        });
    });

    Events.on(engine, 'afterUpdate', () => {
        const bodies = world.bodies.filter(b => b.label === 'fruit');
        bodies.forEach(body => {
            if (body.position.y < 70 && body.velocity.y < 0.1 && Math.abs(body.velocity.x) < 0.1) {
                if (!gameOverFlag) {
                    gameOverFlag = true;
                    setTimeout(() => {
                        document.getElementById('gameOver').style.display = 'flex';
                        document.getElementById('finalScore').textContent = `ìµœì¢… ì ìˆ˜: ${score}`;
                        saveGameResult();
                    }, 500);
                }
            }
        });
    });

    document.getElementById('skinSelector').addEventListener('click', () => {
        document.getElementById('skinModal').style.display = 'flex';
    });

    document.getElementById('closeModalX').addEventListener('click', () => {
        document.getElementById('skinModal').style.display = 'none';
    });

    document.getElementById('closeModal').addEventListener('click', () => {
        document.getElementById('skinModal').style.display = 'none';
        restartGame();
    });

    document.querySelectorAll('.skinOption').forEach(option => {
        option.addEventListener('click', () => {
            document.querySelectorAll('.skinOption').forEach(o => o.classList.remove('selected'));
            option.classList.add('selected');

            const category = option.dataset.category;
            const categoryNames = {
                fruit: 'ê³¼ì¼',
                vehicle: 'íƒˆê²ƒ',
                animal: 'ë™ë¬¼',
                nature: 'ì‹ë¬¼/ìì—°',
                tool: 'ë„êµ¬/ë¬¸ëª…',
                building: 'ê±´ì¶•ë¬¼'
            };

            currentCategory = category;
            document.getElementById('currentSkinName').textContent = categoryNames[category];
        });
    });

    document.getElementById('restartBtn').addEventListener('click', restartGame);

    function restartGame() {
        const bodies = world.bodies.filter(b => b.label === 'fruit');
        World.remove(world, bodies);
        score = 0;
        gameOverFlag = false;
        canDrop = true;
        currentFruitLevel = Math.floor(Math.random() * 5);
        nextFruitLevel = Math.floor(Math.random() * 5);
        document.getElementById('score').textContent = 'ì ìˆ˜: 0';
        document.getElementById('gameOver').style.display = 'none';
        updateNextFruit();
    }

    Events.on(render, 'afterRender', () => {
        const context = render.context;
        const bodies = world.bodies.filter(b => b.label === 'fruit');

        bodies.forEach(body => {
            const fruit = categories[currentCategory][body.fruitLevel];
            const pos = body.position;

            context.save();
            context.translate(pos.x, pos.y);
            context.rotate(body.angle);

            context.fillStyle = 'white';
            context.strokeStyle = 'rgba(0,0,0,0.3)';
            context.lineWidth = 2;
            context.font = `bold ${fruit.size * 0.3}px Arial`;
            context.textAlign = 'center';
            context.textBaseline = 'middle';

            context.strokeText(fruit.name, 0, 0);
            context.fillText(fruit.name, 0, 0);

            context.restore();
        });
    });

    function saveGameResult() {
        let gameResult = 0;
        if (score >= 10000) {
            gameResult = 2;
        } else if (score >= 1000) {
            gameResult = 1;
        }

        const gameData = {
            gameNo: 2,
            gameResult: gameResult,
            gameScore: score
        };

        console.log('ê²Œì„ ê²°ê³¼ ì „ì†¡:', gameData);

        if (window.FlutterChannel) {
            window.FlutterChannel.postMessage(JSON.stringify(gameData));
        }
    }

    updateNextFruit();
</script>
</body>

</html>