<!DOCTYPE html>
<html lang="ko">
    <!-- Í∞úÏÑ†Ìï¥ÏïºÌï† Í±∞ 
        1) Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù Ïãú, Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÍ≥† Îπ†Ï†∏ÎÇòÏò¨ Ïàò ÏûàÎäî XÎ≤ÑÌäº Ï∂îÍ∞Ä
        2) ÏµúÏ¢Ö Îã®Í≥Ñ Ïò§Î∏åÏ†ùÌä∏ Î≥ëÌï© Ïãú ÏÇ¨ÎùºÏßÄÍ≤å ÎßåÎì§Ïñ¥ÏÑú Î¨¥ÌïúÎ™®Îìú Í∞ÄÎä•ÌïòÍ≤å ÌïòÍ∏∞
        3) ÎìúÎûòÍ∑∏ ÏãúÏûë Î∂ÄÎ∂ÑÏóêÏÑú Ïò§Î∏åÏ†ùÌä∏Í∞Ä Îñ®Ïñ¥Ïßê. ÎìúÎûòÍ∑∏ ÎÜìÏùÑ Îïå Îñ®Ïñ¥Îú®Î¶¨ÎèÑÎ°ù Î≥ÄÍ≤Ω
        4) Ïò§Î∏åÏ†ùÌä∏Í∞Ä Ï¢åÏö∞Î°ú ÎÇòÍ∞à Ïàò ÏûàÎäî Í≤ΩÍ≥ÑÏÑ† ÎßåÎì§Ïñ¥ÏïºÌï®
        5) Ïò§Î∏åÏ†ùÌä∏Î•º Îñ®Ïñ¥Îú®Î¶¨ÏûêÎßàÏûê, ÏÇ¨Ïö©ÏûêÍ∞Ä Îì§Í≥† ÏûàÎäî Ïò§Î∏åÏ†ùÌä∏Í∞Ä Îã§Ïùå Ïò§Î∏åÏ†ùÌä∏Î°ú Î≥ÄÍ≤ΩÎêòÏñ¥ÏïºÌï®
        6) Ïò§Î∏åÏ†ùÌä∏ Îñ®Ïñ¥Îú®Î¶¥ Îïå, ÌîåÎ†àÏù¥Ïñ¥Í∞Ä Ïù∏ÏßÄÌï† Ïàò ÏûàÎèÑÎ°ù Ìö®Í≥ºÏùå ÏßëÏñ¥ÎÑ£Í∏∞
        7) bgm
        8) ÏßÄÍ∏à ÌòÑÏû¨ Ï•êÍ≥† ÏûàÎäî Ïò§Î∏åÏ†ùÌä∏Í∞Ä nextÎ°ú ÌëúÏãúÎê®. Í∑∏ Îã§Ïùå Ïò§Î∏åÏ†ùÌä∏Î•º nextÎ°ú ÌëúÏãúÌï¥ÏïºÌï®
    -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÌïúÍ∏Ä ÏàòÎ∞ïÍ≤åÏûÑ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        #gameContainer {
            position: relative;
            width: 380px;
            height: 650px;
            background: #FFF9E6;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* ÏÉÅÎã® UI ÏòÅÏó≠ */
        #topUI {
            position: relative;
            width: 100%;
            background: linear-gradient(to bottom, #FFE5B4 0%, #FFF9E6 100%);
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        #scoreBoard {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        #score {
            background: white;
            border: 3px solid #FFB84D;
            border-radius: 20px;
            padding: 8px 20px;
            font-size: 20px;
            font-weight: bold;
            color: #FF6B35;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        #nextFruitBox {
            background: white;
            border: 3px solid #FFB84D;
            border-radius: 20px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        #nextFruitBox .label {
            font-size: 12px;
            font-weight: bold;
            color: #666;
            margin-bottom: 5px;
        }

        #nextFruitPreview {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #skinSelector {
            background: white;
            border: 3px solid #FFB84D;
            border-radius: 20px;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            color: #FF6B35;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        #skinSelector:active {
            transform: scale(0.95);
        }

        #evolutionBar {
            background: white;
            border: 3px solid #FFB84D;
            border-radius: 15px;
            padding: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        #evolutionBar .label {
            font-size: 12px;
            font-weight: bold;
            color: #666;
            margin-bottom: 8px;
            text-align: center;
        }

        #evolutionList {
            display: flex;
            justify-content: space-between;
            gap: 3px;
            overflow-x: auto;
            padding: 5px 0;
        }

        .evolutionItem {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 28px;
        }

        .evolutionCircle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: bold;
            color: white;
            border: 2px solid #ddd;
            margin-bottom: 3px;
        }

        .evolutionName {
            font-size: 7px;
            color: #666;
            text-align: center;
            line-height: 1.1;
        }

        /* Í≤åÏûÑ ÏòÅÏó≠ */
        #gameArea {
            position: relative;
            flex: 1;
            background: linear-gradient(to bottom, #E8F4F8 0%, #FFF9E6 50%, #F5DEB3 100%);
        }

        #characters {
            position: absolute;
            top: 20px;
            width: 100%;
            display: flex;
            padding-left: 130px;
            pointer-events: none;
            z-index: 100;
        }

        .character {
            padding: 5px;
        }

        .character>img {
            height: 80px;
            display: block;
        }

        #dropZone {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: rgba(255, 184, 77, 0.15);
            border-bottom: 3px dashed #FFB84D;
            z-index: 50;
        }

        #nextFruit {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 600;
            pointer-events: none;
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            background: transparent;
        }

        /* Ïä§ÌÇ® ÏÑ†ÌÉù Î™®Îã¨ */
        #skinModal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        #skinModalContent {
            background: linear-gradient(to bottom, #FFF9E6, #FFE5B4);
            border: 4px solid #FFB84D;
            border-radius: 25px;
            padding: 30px 20px;
            max-width: 320px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        #skinModalContent h2 {
            text-align: center;
            color: #FF6B35;
            font-size: 28px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0px #FFB84D;
        }

        .skinOption {
            background: white;
            border: 3px solid #FFB84D;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.2s;
        }

        .skinOption:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .skinOption.selected {
            background: #FFF4E0;
            border-color: #FF6B35;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.3);
        }

        .skinOption .icon {
            font-size: 32px;
            min-width: 40px;
            text-align: center;
        }

        .skinOption .name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        #closeModal {
            background: #FF6B35;
            color: white;
            border: none;
            border-radius: 15px;
            padding: 12px;
            width: 100%;
            font-size: 18px;
            font-weight: bold;
            margin-top: 15px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
        }

        #closeModal:active {
            transform: scale(0.95);
        }

        /* Í≤åÏûÑ Ïò§Î≤Ñ */
        #gameOver {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        #gameOverContent {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
        }

        #gameOverContent h2 {
            font-size: 36px;
            color: #FF6B35;
            margin-bottom: 20px;
        }

        #gameOverContent p {
            font-size: 24px;
            color: #333;
            margin-bottom: 30px;
        }

        #restartBtn {
            background: #FF6B35;
            color: white;
            border: none;
            border-radius: 15px;
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
        }

        #restartBtn:active {
            transform: scale(0.95);
        }
    </style>
</head>

<body>
    <div id="gameContainer">
        <!-- ÏÉÅÎã® UI ÏòÅÏó≠ -->
        <div id="topUI">
            <div id="scoreBoard">
                <div id="score">Ï†êÏàò: 0</div>
                <div id="nextFruitBox">
                    <div class="label">NEXT</div>
                    <div id="nextFruitPreview"></div>
                </div>
            </div>
            <div id="skinSelector">
                <span>üé®</span>
                <span id="currentSkinName">Í≥ºÏùº</span>
            </div>
            <div id="characters">
                <div class="character">
                    <img src="./water_melon_cut.png" alt="ÏàòÎ∞ïÎ®πÎäîÌÜ†ÎèåÏù¥ÏôÄÌò∏ÏàúÏù¥" />
                </div>
            </div>
        </div>

        <!-- Í≤åÏûÑ ÏòÅÏó≠ -->
        <div id="gameArea">
            <div id="dropZone"></div>
            <div id="nextFruit"></div>
            <canvas id="gameCanvas"></canvas>
        </div>

        <!-- Ïä§ÌÇ® ÏÑ†ÌÉù Î™®Îã¨ -->
        <div id="skinModal">
            <div id="skinModalContent">
                <h2>Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù</h2>
                <div class="skinOption selected" data-category="fruit">
                    <div class="icon">üçé</div>
                    <div class="name">Í≥ºÏùº</div>
                </div>
                <div class="skinOption" data-category="vehicle">
                    <div class="icon">üöó</div>
                    <div class="name">ÌÉàÍ≤É</div>
                </div>
                <div class="skinOption" data-category="animal">
                    <div class="icon">üêæ</div>
                    <div class="name">ÎèôÎ¨º</div>
                </div>
                <div class="skinOption" data-category="nature">
                    <div class="icon">üå±</div>
                    <div class="name">ÏãùÎ¨º/ÏûêÏó∞</div>
                </div>
                <div class="skinOption" data-category="tool">
                    <div class="icon">‚öôÔ∏è</div>
                    <div class="name">ÎèÑÍµ¨/Î¨∏Î™Ö</div>
                </div>
                <div class="skinOption" data-category="building">
                    <div class="icon">üè†</div>
                    <div class="name">Í±¥Ï∂ïÎ¨º</div>
                </div>
                <button id="closeModal">ÌôïÏù∏</button>
            </div>
        </div>

        <!-- Í≤åÏûÑ Ïò§Î≤Ñ -->
        <div id="gameOver">
            <div id="gameOverContent">
                <h2>Í≤åÏûÑ Ïò§Î≤Ñ!</h2>
                <p id="finalScore">ÏµúÏ¢Ö Ï†êÏàò: 0</p>
                <button id="restartBtn">Îã§Ïãú ÌïòÍ∏∞</button>
            </div>
        </div>
    </div>

    <script>
        const categories = {
            fruit: [
                { name: 'Ï≤¥Î¶¨', color: '#ff6b6b', size: 25, shape: 'circle' },
                { name: 'Í∑§', color: '#ffa500', size: 35, shape: 'circle' },
                { name: 'ÏÇ¨Í≥º', color: '#ff4757', size: 45, shape: 'circle' },
                { name: 'Î∞∞', color: '#ffd93d', size: 55, shape: 'circle' },
                { name: 'ÏûêÎ™Ω', color: '#ffb8b8', size: 65, shape: 'circle' },
                { name: 'ÌååÏù∏Ïï†Ìîå', color: '#f9ca24', size: 70, shape: 'pineapple' },
                { name: 'Î©úÎ°†', color: '#95e1d3', size: 75, shape: 'oval' },
                { name: 'ÎßùÍ≥†', color: '#feca57', size: 100, shape: 'mango' },
                { name: 'Ïö©Í≥º', color: '#ff6348', size: 115, shape: 'oval' },
                { name: 'ÏàòÎ∞ï', color: '#38ada9', size: 150, shape: 'circle' },
                { name: 'Í≥ºÏùºÎ∞îÍµ¨Îãà', color: '#cd84f1', size: 200, shape: 'basket' }
            ],
            vehicle: [
                { name: 'ÌÇ•Î≥¥Îìú', color: '#74b9ff', size: 30, shape: 'kickboard' },
                { name: 'ÏûêÏ†ÑÍ±∞', color: '#0984e3', size: 40, shape: 'bicycle' },
                { name: 'Ïò§ÌÜ†Î∞îÏù¥', color: '#6c5ce7', size: 50, shape: 'motorcycle' },
                { name: 'ÏûêÎèôÏ∞®', color: '#fd79a8', size: 60, shape: 'car' },
                { name: 'Ìä∏Îü≠', color: '#fdcb6e', size: 70, shape: 'truck' },
                { name: 'Î≤ÑÏä§', color: '#f39c12', size: 80, shape: 'bus' },
                { name: 'Í∏∞Ï∞®', color: '#e17055', size: 90, shape: 'train' },
                { name: 'ÎπÑÌñâÍ∏∞', color: '#00b894', size: 95, shape: 'airplane' },
                { name: 'Ïö∞Ï£ºÏÑ†', color: '#a29bfe', size: 105, shape: 'spaceship' },
                { name: 'Î°úÏºì', color: '#e84393', size: 150, shape: 'rocket' },
                { name: 'UFO', color: '#00cec9', size: 200, shape: 'ufo' }
            ],
            animal: [
                { name: 'Í∞úÎØ∏', color: '#2d3436', size: 20, shape: 'circle' },
                { name: 'Î≤å', color: '#feca57', size: 28, shape: 'circle' },
                { name: 'Ï•ê', color: '#95afc0', size: 35, shape: 'circle' },
                { name: 'ÌÜ†ÎÅº', color: '#ffcccc', size: 45, shape: 'circle' },
                { name: 'Ïó¨Ïö∞', color: '#ff7675', size: 55, shape: 'circle' },
                { name: 'ÎäëÎåÄ', color: '#636e72', size: 65, shape: 'circle' },
                { name: 'Í≥∞', color: '#8b4513', size: 75, shape: 'circle' },
                { name: 'ÏÇ¨Ïûê', color: '#f39c12', size: 85, shape: 'circle' },
                { name: 'ÏΩîÎÅºÎ¶¨', color: '#95a5a6', size: 95, shape: 'circle' },
                { name: 'Í≥†Îûò', color: '#3498db', size: 150, shape: 'whale' },
                { name: 'Ïö©', color: '#9b59b6', size: 200, shape: 'dragon' }
            ],
            nature: [
                { name: 'ÏÉàÏãπ', color: '#b8e994', size: 25, shape: 'sprout' },
                { name: 'ÌíÄ', color: '#78e08f', size: 30, shape: 'grass' },
                { name: 'ÍΩÉ', color: '#ffb8b8', size: 40, shape: 'flower' },
                { name: 'Í¥ÄÎ™©', color: '#6ab04c', size: 50, shape: 'bush' },
                { name: 'ÎÇòÎ¨¥', color: '#4a7c59', size: 60, shape: 'tree' },
                { name: 'Ïà≤', color: '#218c74', size: 75, shape: 'circle' },
                { name: 'Ï†ïÏõê', color: '#38ada9', size: 85, shape: 'circle' },
                { name: 'ÏÇ∞', color: '#8395a7', size: 90, shape: 'mountain' },
                { name: 'Î∞ÄÎ¶º', color: '#05c46b', size: 95, shape: 'circle' },
                { name: 'ÎåÄÏßÄ', color: '#8b7355', size: 150, shape: 'circle' },
                { name: 'ÌñâÏÑ±', color: '#4834df', size: 200, shape: 'circle' }
            ],
            tool: [
                { name: 'Îèå', color: '#95a5a6', size: 30, shape: 'stone' },
                { name: 'Ïπº', color: '#bdc3c7', size: 35, shape: 'knife' },
                { name: 'ÎßùÏπò', color: '#7f8c8d', size: 45, shape: 'hammer' },
                { name: 'Ìôú', color: '#d35400', size: 55, shape: 'bow' },
                { name: 'Ï¢ÖÏù¥', color: '#ecf0f1', size: 50, shape: 'paper' },
                { name: 'ÎåÄÌè¨', color: '#34495e', size: 65, shape: 'cannon' },
                { name: 'ÏãúÍ≥Ñ', color: '#f39c12', size: 70, shape: 'circle' },
                { name: 'Ï†ÑÍµ¨', color: '#f1c40f', size: 80, shape: 'bulb' },
                { name: 'Ïª¥Ìì®ÌÑ∞', color: '#3498db', size: 100, shape: 'computer' },
                { name: 'Î°úÎ¥á', color: '#9b59b6', size: 150, shape: 'robot' },
                { name: 'AI', color: '#e74c3c', size: 200, shape: 'circle' }
            ],
            building: [
                { name: 'ÌÖêÌä∏', color: '#f39c12', size: 35, shape: 'tent' },
                { name: 'Ïò§ÎëêÎßâ', color: '#d35400', size: 45, shape: 'hut' },
                { name: 'Ïßë', color: '#e74c3c', size: 55, shape: 'house' },
                { name: 'ÏïÑÌååÌä∏', color: '#95a5a6', size: 70, shape: 'apartment' },
                { name: 'ÎßàÏùÑ', color: '#3498db', size: 80, shape: 'circle' },
                { name: 'ÎèÑÏãú', color: '#2c3e50', size: 90, shape: 'circle' },
                { name: 'ÏàòÎèÑ', color: '#34495e', size: 95, shape: 'circle' },
                { name: 'Íµ≠Í∞Ä', color: '#16a085', size: 100, shape: 'circle' },
                { name: 'ÎåÄÎ•ô', color: '#27ae60', size: 115, shape: 'circle' },
                { name: 'ÏßÄÍµ¨', color: '#2980b9', size: 150, shape: 'circle' },
                { name: 'Ïö∞Ï£ºÏ†ïÍ±∞Ïû•', color: '#8e44ad', size: 200, shape: 'station' }
            ]
        };

        const { Engine, Render, Runner, Bodies, World, Events, Body } = Matter;

        const canvas = document.getElementById('gameCanvas');
        const gameArea = document.getElementById('gameArea');
        const width = gameArea.clientWidth;
        const height = gameArea.clientHeight;

        const engine = Engine.create();
        const world = engine.world;
        world.gravity.y = 1;

        const render = Render.create({
            canvas: canvas,
            engine: engine,
            options: {
                width: width,
                height: height,
                wireframes: false,
                background: 'transparent'
            }
        });

        Render.run(render);
        const runner = Runner.create();
        Runner.run(runner, engine);

        // Î≤Ω ÏÉùÏÑ±
        const wallOptions = { isStatic: true, render: { fillStyle: '#dfe6e9' } };
        const ground = Bodies.rectangle(width / 2, height - 10, width, 20, wallOptions);
        const leftWall = Bodies.rectangle(10, height / 2, 20, height, wallOptions);
        const rightWall = Bodies.rectangle(width - 10, height / 2, 20, height, wallOptions);

        World.add(world, [ground, leftWall, rightWall]);

        let score = 0;
        let currentCategory = 'fruit';
        let nextFruitLevel = Math.floor(Math.random() * 5);
        let canDrop = true;
        let gameOverFlag = false;
        let dropX = width / 2;

        function createBody(level, x, y) {
            const fruit = categories[currentCategory][level];
            let body;

            switch (fruit.shape) {
                case 'circle':
                    body = Bodies.circle(x, y, fruit.size / 2, {
                        restitution: 0.3,
                        friction: 0.5,
                        density: 0.001
                    });
                    break;
                case 'oval':
                    body = Bodies.circle(x, y, fruit.size / 2, {
                        restitution: 0.3,
                        friction: 0.5,
                        density: 0.001
                    });
                    Body.scale(body, 1, 1.2);
                    break;
                case 'whale':
                    body = Bodies.rectangle(x, y, fruit.size * 1.5, fruit.size * 0.6, {
                        restitution: 0.2,
                        friction: 0.5,
                        density: 0.001,
                        chamfer: { radius: fruit.size * 0.3 }
                    });
                    break;
                case 'rocket':
                case 'knife':
                    body = Bodies.rectangle(x, y, fruit.size * 0.5, fruit.size * 1.3, {
                        restitution: 0.3,
                        friction: 0.5,
                        density: 0.001,
                        chamfer: { radius: [fruit.size * 0.25, fruit.size * 0.25, 0, 0] }
                    });
                    break;
                case 'bus':
                case 'truck':
                case 'train':
                    body = Bodies.rectangle(x, y, fruit.size * 1.3, fruit.size * 0.7, {
                        restitution: 0.2,
                        friction: 0.6,
                        density: 0.001,
                        chamfer: { radius: fruit.size * 0.1 }
                    });
                    break;
                case 'airplane':
                    body = Bodies.rectangle(x, y, fruit.size * 1.5, fruit.size * 0.5, {
                        restitution: 0.3,
                        friction: 0.4,
                        density: 0.0008,
                        chamfer: { radius: [fruit.size * 0.25, fruit.size * 0.25, 0, 0] }
                    });
                    break;
                case 'mountain':
                    const mountainVertices = [
                        { x: -fruit.size * 0.6, y: fruit.size * 0.4 },
                        { x: 0, y: -fruit.size * 0.5 },
                        { x: fruit.size * 0.6, y: fruit.size * 0.4 }
                    ];
                    body = Bodies.fromVertices(x, y, mountainVertices, {
                        restitution: 0.1,
                        friction: 0.8,
                        density: 0.001
                    });
                    break;
                case 'house':
                case 'apartment':
                    body = Bodies.rectangle(x, y, fruit.size * 0.8, fruit.size * 1.1, {
                        restitution: 0.1,
                        friction: 0.7,
                        density: 0.001,
                        chamfer: { radius: fruit.size * 0.05 }
                    });
                    break;
                default:
                    body = Bodies.circle(x, y, fruit.size / 2, {
                        restitution: 0.3,
                        friction: 0.5,
                        density: 0.001
                    });
            }

            body.render.fillStyle = fruit.color;
            body.fruitLevel = level;
            body.label = 'fruit';

            return body;
        }

        function updateNextFruit() {
            const nextFruitDiv = document.getElementById('nextFruit');
            const nextFruitPreview = document.getElementById('nextFruitPreview');
            const fruit = categories[currentCategory][nextFruitLevel];

            // Î©îÏù∏ ÎìúÎ°≠ ÎØ∏Î¶¨Î≥¥Í∏∞
            nextFruitDiv.innerHTML = `
                <div style="
                    background: ${fruit.color};
                    border-radius: ${fruit.shape === 'circle' ? '50%' : '15px'};
                    width: ${fruit.size}px;
                    height: ${fruit.size}px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    color: white;
                    font-size: ${fruit.size * 0.3}px;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
                ">${fruit.name}</div>
            `;

            // ÏÉÅÎã® NEXT Î∞ïÏä§ ÎØ∏Î¶¨Î≥¥Í∏∞
            nextFruitPreview.innerHTML = `
                <div style="
                    background: ${fruit.color};
                    border-radius: 50%;
                    width: 35px;
                    height: 35px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    color: white;
                    font-size: 11px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                ">${fruit.name}</div>
            `;
        }

        function updateEvolutionBar() {
            const evolutionList = document.getElementById('evolutionList');
            const items = categories[currentCategory];

            evolutionList.innerHTML = items.map((item, index) => `
                <div class="evolutionItem">
                    <div class="evolutionCircle" style="background: ${item.color}; border-color: ${item.color};">
                        ${index + 1}
                    </div>
                    <div class="evolutionName">${item.name}</div>
                </div>
            `).join('');
        }

        function dropFruit(x) {
            if (!canDrop || gameOverFlag) return;

            canDrop = false;
            const body = createBody(nextFruitLevel, x, 80);
            World.add(world, body);

            setTimeout(() => {
                canDrop = true;
                nextFruitLevel = Math.floor(Math.random() * 5);
                updateNextFruit();
            }, 500);
        }

        // ÌÇ§Î≥¥Îìú Ïù¥Î≤§Ìä∏ (Î∞©Ìñ•ÌÇ§ ÌïòÎã®ÏúºÎ°ú ÎìúÎ°≠)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowDown' || e.key === 'Down') {
                e.preventDefault();
                dropFruit(dropX);
            }
        });

        // ÌÑ∞Ïπò Î∞è ÎßàÏö∞Ïä§ Ïù¥Î≤§Ìä∏
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            dropX = touch.clientX - rect.left;

            const nextFruitDiv = document.getElementById('nextFruit');
            nextFruitDiv.style.left = dropX + 'px';
            nextFruitDiv.style.transform = 'translateX(-50%)';
        });

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            dropX = touch.clientX - rect.left;
            dropFruit(dropX);
        });

        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            dropX = e.clientX - rect.left;

            const nextFruitDiv = document.getElementById('nextFruit');
            nextFruitDiv.style.left = dropX + 'px';
            nextFruitDiv.style.transform = 'translateX(-50%)';
        });

        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            dropX = e.clientX - rect.left;
            dropFruit(dropX);
        });

        // Ï∂©Îèå Í∞êÏßÄ
        Events.on(engine, 'collisionStart', (event) => {
            event.pairs.forEach((pair) => {
                const { bodyA, bodyB } = pair;

                if (bodyA.label === 'fruit' && bodyB.label === 'fruit' &&
                    bodyA.fruitLevel === bodyB.fruitLevel &&
                    bodyA.fruitLevel < categories[currentCategory].length - 1) {

                    const level = bodyA.fruitLevel;
                    const x = (bodyA.position.x + bodyB.position.x) / 2;
                    const y = (bodyA.position.y + bodyB.position.y) / 2;

                    World.remove(world, [bodyA, bodyB]);

                    const newBody = createBody(level + 1, x, y);
                    World.add(world, newBody);

                    score += (level + 1) * 10;
                    document.getElementById('score').textContent = `Ï†êÏàò: ${score}`;
                }
            });
        });

        // Í≤åÏûÑ Ïò§Î≤Ñ Ï≤¥ÌÅ¨
        Events.on(engine, 'afterUpdate', () => {
            const bodies = world.bodies.filter(b => b.label === 'fruit');
            bodies.forEach(body => {
                if (body.position.y < 80 && body.velocity.y < 0.1 && Math.abs(body.velocity.x) < 0.1) {
                    if (!gameOverFlag) {
                        gameOverFlag = true;
                        setTimeout(() => {
                            document.getElementById('gameOver').style.display = 'flex';
                            document.getElementById('finalScore').textContent = `ÏµúÏ¢Ö Ï†êÏàò: ${score}`;
                        }, 500);
                    }
                }
            });
        });

        // Ïä§ÌÇ® Î™®Îã¨ Í¥ÄÎ†®
        document.getElementById('skinSelector').addEventListener('click', () => {
            document.getElementById('skinModal').style.display = 'flex';
        });

        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('skinModal').style.display = 'none';
            restartGame();
        });

        document.querySelectorAll('.skinOption').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.skinOption').forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');

                const category = option.dataset.category;
                const categoryNames = {
                    fruit: 'Í≥ºÏùº',
                    vehicle: 'ÌÉàÍ≤É',
                    animal: 'ÎèôÎ¨º',
                    nature: 'ÏãùÎ¨º/ÏûêÏó∞',
                    tool: 'ÎèÑÍµ¨/Î¨∏Î™Ö',
                    building: 'Í±¥Ï∂ïÎ¨º'
                };

                currentCategory = category;
                document.getElementById('currentSkinName').textContent = categoryNames[category];
                updateEvolutionBar();
            });
        });

        // Ïû¨ÏãúÏûë
        document.getElementById('restartBtn').addEventListener('click', restartGame);

        function restartGame() {
            const bodies = world.bodies.filter(b => b.label === 'fruit');
            World.remove(world, bodies);
            score = 0;
            gameOverFlag = false;
            canDrop = true;
            nextFruitLevel = Math.floor(Math.random() * 5);
            document.getElementById('score').textContent = 'Ï†êÏàò: 0';
            document.getElementById('gameOver').style.display = 'none';
            updateNextFruit();
            updateEvolutionBar();
        }

        // Ïò§Î∏åÏ†ùÌä∏Ïóê ÌÖçÏä§Ìä∏ Î†åÎçîÎßÅ
        Events.on(render, 'afterRender', () => {
            const context = render.context;
            const bodies = world.bodies.filter(b => b.label === 'fruit');

            bodies.forEach(body => {
                const fruit = categories[currentCategory][body.fruitLevel];
                const pos = body.position;

                context.save();
                context.translate(pos.x, pos.y);
                context.rotate(body.angle);

                context.fillStyle = 'white';
                context.strokeStyle = 'rgba(0,0,0,0.3)';
                context.lineWidth = 2;
                context.font = `bold ${fruit.size * 0.3}px Arial`;
                context.textAlign = 'center';
                context.textBaseline = 'middle';

                context.strokeText(fruit.name, 0, 0);
                context.fillText(fruit.name, 0, 0);

                context.restore();
            });
        });

        // Ï¥àÍ∏∞Ìôî
        updateNextFruit();
        updateEvolutionBar();
    </script>
</body>

</html>